# メモリ機能テスト手順

## 📋 実装完了内容

### 1. データベーススキーマの拡張
- `memories`テーブルに以下のカラムを追加：
  - `user_id`: ユーザーID（auth.users参照）
  - `memory_type`: メモリタイプ（goal, behavior_pattern, affect_trend, advice_history, personal_info）
  - `confidence`: 信頼度（0.0〜1.0）
  - `expires_at`: 有効期限
  - `deleted_at`: 削除日時

### 2. メモリ抽出機能
- 会話から重要情報を自動抽出
- 5メッセージごとに自動実行
- 信頼度0.7以上のメモリのみ保存

### 3. メモリタイプ
- `personal_info`: 身の回りの情報（名前、年齢、家族構成など）
- `goal`: 目標や意図
- `behavior_pattern`: 行動パターン
- `affect_trend`: 感情の傾向
- `advice_history`: アドバイス履歴

---

## 🔧 セットアップ手順

### Step 1: マイグレーションの実行

Supabaseダッシュボードで以下のマイグレーションを実行してください：

1. Supabaseダッシュボードを開く
2. **SQL Editor**を開く
3. `supabase/migrations/007_extend_memories_table.sql`の内容をコピー＆ペースト
4. **Run**をクリックして実行

**注意**: 
- 既存の`memories`テーブルがある場合は、カラムが追加されます
- `character_id`のNOT NULL制約が解除されます
- 既存データの`memory_type`は`advice_history`に設定されます

### Step 2: 環境変数の確認

以下の環境変数が設定されているか確認してください：

#### 必須の環境変数
```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_URL=your_supabase_url  # サーバーサイド用
SUPABASE_ANON_KEY=your_anon_key  # サーバーサイド用

# Gemini API
GOOGLE_GENERATIVE_AI_API_KEY=your_gemini_api_key
GEMINI_MODEL=gemini-2.0-flash-exp  # または gemini-2.5-flash

# Cartesia TTS
CARTESIA_API_KEY=your_cartesia_api_key
CARTESIA_VERSION=2025-04-16

# OpenAI Whisper
OPENAI_API_KEY=your_openai_api_key
```

#### オプションの環境変数
```bash
# アプリのベースURL（Edge Runtimeで使用）
NEXT_PUBLIC_APP_URL=http://localhost:3000  # 開発環境
# 本番環境では自動検出されます（VERCEL_URL使用）
```

### Step 3: 開発サーバーの起動

```bash
cd front
npm run dev
```

---

## 🧪 動作テスト手順

### Test 1: メモリ抽出の基本動作

1. **チャットページを開く**
   - ブラウザで `http://localhost:3000/chat` を開く
   - ログインが必要な場合はログイン

2. **会話を開始**
   - 音声またはテキストで会話を開始
   - 以下のような内容を話す：
     ```
     ユーザー: 「こんにちは、私は田中太郎です。30歳です。」
     アシスタント: （応答）
     
     ユーザー: 「実は来月までに転職したいんです。」
     アシスタント: （応答）
     
     ユーザー: 「最近ストレスで夜更かししがちなんです。」
     アシスタント: （応答）
     
     ユーザー: 「家族構成は両親と同居しています。」
     アシスタント: （応答）
     
     ユーザー: 「趣味は読書と音楽鑑賞です。」
     アシスタント: （応答）
     ```

3. **5メッセージ目で自動抽出**
   - 5メッセージ目（ユーザーの5回目の発話）で自動的にメモリ抽出が実行されます
   - ブラウザの開発者ツール（F12）のコンソールを確認
   - 以下のようなログが表示されます：
     ```
     Step 4.5: Starting memory extraction...
     Step 4.5: Extracted 3 memories: [...]
     Step 4.5: Memories saved: {...}
     ```

### Test 2: データベースの確認

1. **Supabaseダッシュボードで確認**
   - **Table Editor** → `memories`テーブルを開く
   - 抽出されたメモリが保存されているか確認
   - `memory_type`, `topic`, `content`, `confidence`を確認

2. **想定されるメモリ例**
   ```json
   {
     "memory_type": "personal_info",
     "topic": "名前",
     "content": "田中太郎",
     "confidence": 0.95
   },
   {
     "memory_type": "personal_info",
     "topic": "年齢",
     "content": "30歳",
     "confidence": 0.90
   },
   {
     "memory_type": "goal",
     "topic": "転職の目標",
     "content": "来月までに転職したい",
     "confidence": 0.85
   },
   {
     "memory_type": "behavior_pattern",
     "topic": "夜更かし",
     "content": "ストレスで夜更かししがち",
     "confidence": 0.80
   },
   {
     "memory_type": "personal_info",
     "topic": "家族構成",
     "content": "両親と同居",
     "confidence": 0.90
   }
   ```

### Test 3: エラーハンドリングの確認

1. **メモリ抽出のエラーが発生しても会話は継続することを確認**
   - メモリ抽出でエラーが発生しても、チャット機能は正常に動作するはず
   - コンソールにエラーログが表示されるが、会話には影響しない

2. **信頼度が低いメモリは保存されないことを確認**
   - 曖昧な情報や推測のみの情報は信頼度が低く設定される
   - 信頼度0.7未満のメモリは保存されない

### Test 4: メモリ取得のテスト

将来的にメモリを取得する機能を実装した場合のテスト用：

```typescript
import { getMemories } from "@/lib/actions/memory";

// 全メモリを取得
const result = await getMemories();

// personal_infoのみ取得
const personalInfo = await getMemories("personal_info");
```

---

## 🐛 トラブルシューティング

### 問題1: メモリが抽出されない

**確認事項**:
- Gemini APIキーが正しく設定されているか
- コンソールにエラーログが表示されていないか
- 5メッセージ経過しているか（ユーザーの発話が5回以上）

**対処法**:
- ブラウザの開発者ツールでコンソールを確認
- エラーメッセージを確認して修正

### 問題2: メモリが保存されない

**確認事項**:
- Supabaseの認証が正しく動作しているか
- RLSポリシーが正しく設定されているか
- `user_id`が正しく設定されているか

**対処法**:
- SupabaseダッシュボードでRLSポリシーを確認
- `memories`テーブルのポリシーを確認

### 問題3: メモリ抽出が遅い

**確認事項**:
- Gemini APIのレスポンスタイム
- ネットワーク接続

**対処法**:
- メモリ抽出は非同期で実行されているため、会話には影響しない
- 必要に応じて`MEMORY_EXTRACTION_THRESHOLD`を調整（デフォルト: 5）

### 問題4: Edge Runtimeでのエラー

**確認事項**:
- `NEXT_PUBLIC_APP_URL`が正しく設定されているか
- Edge Runtimeから内部APIエンドポイントにアクセスできるか

**対処法**:
- 開発環境では`http://localhost:3000`を設定
- 本番環境では`VERCEL_URL`が自動検出される

---

## 📊 次のステップ（将来的な拡張）

1. **セッション要約機能**
   - セッション終了時に要約を作成
   - 要約からメモリを抽出

2. **メモリの利用**
   - 会話プロンプトにメモリを含める
   - 過去のメモリを参照して応答を生成

3. **メモリの管理UI**
   - 保存されたメモリを表示・編集・削除
   - メモリタイプ別の表示

4. **メモリの有効期限管理**
   - `expires_at`に基づいて自動削除
   - ユーザー設定から保持期間を設定

---

## ✅ チェックリスト

- [ ] マイグレーションを実行済み
- [ ] 環境変数が設定済み
- [ ] 開発サーバーが起動している
- [ ] 5メッセージ以上会話した
- [ ] コンソールにメモリ抽出のログが表示された
- [ ] Supabaseでメモリが保存されていることを確認
- [ ] エラーが発生しても会話が継続することを確認

