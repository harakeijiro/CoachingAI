画面設計書（CoachingAI｜OAuth版・テーマ→画像キャラ選択・統合Auth）

本ドキュメントは要件定義に基づき、UIレイアウト／主要コンポーネント／状態遷移／ルーティング／エラーハンドリング／非機能UI要件を定義する。
認証は Supabase Auth（Google／Microsoft） の External OAuth のみを使用する。
初回導線：ログイン → テーマ選択 → テーマ別キャラを“静的画像のみ”で選択 → オンボーディング → 対話。

0. 前提・共通仕様

ヘッダー（共通）：左＝ロゴ（トップへ）／右＝未ログイン「新規登録」「ログイン」・ログイン後「設定」「ログアウト」「対話へ」。
背景は透明＋ブラー、スクロールで白背景に縮小固定。

フッター（共通）：規約／プライバシー／問い合わせ（ヘルプ）。

デザイン／演出：モード系（白＋黒＋インディゴ）。映像主役・最小コピー。
レスポンシブ、アクセシビリティ（A11y）、トースト／モーダル指針は従来踏襲。

3D＆音声：3D描画・Cartesia TTS 同期、記憶最適化UIは従来の要件通り。

データ前提：profiles.selected_character_id (uuid|null)・profiles.default_theme (text|null)、characters テーブル（id,name,thumbnail_url,theme …）。

1. ランディングページ /
1-1. トーン＆コンセプト

コンセプトコピー：「話すことで、心が 揺れる。」

配色：白＋黒＋インディゴ。淡いグラデーションで上品に。

1-2. ヒーロー（モーダル認証）

レイアウト：
- ヘッダー：左＝ロゴ＋アイコン、右＝「ログイン」「無料で始める」ボタン
- メイン：タイピングアニメーション「話すことで心が 揺れる」
- サブテキスト：「CoachingAIは、あなた専用のAIコーチ 心・恋愛・キャリア、すべての対話を支える存在です」
- CTAボタン：「無料で始める」「詳しく見る」
- フッター：利用規約・プライバシー・ヘルプリンク

認証モーダル：
- 背景：ぼかし効果付きオーバーレイ
- カード：白背景、角丸、シャドウ
- 内容：「ようこそ CoachingAI」タイトル
- ソーシャルログインボタン：Google・Microsoft
- 閉じるボタン：右上×ボタン、ESCキー対応

2. 認証（モーダルベース） /auth
2-1. 構成

実装方式：ランディングページ内のモーダルとして実装

モーダル内容：
- タイトル：「ようこそ CoachingAI」
- ソーシャルログインボタン：Google・Microsoft
- 成功・エラーメッセージ表示エリア
- 閉じるボタン：右上×ボタン

動作：
- ボタン押下→ Supabase OAuth（popup優先・不可ならredirect）
- 成功→ /decision
- エラー（同意拒否／ポップアップブロック／リダイレクトURI不一致／3rd-party Cookie 制限）はトースト＋再試行・ヘルプ

3. 分岐（初回／既存） /decision（認証必須・UI極小）

目的：ログイン直後に実データで初回/既存を仕分け。

ロジック：

profiles.selected_character_id === null → /theme（テーマ選択ハブ）

!== null → /chat（前回コーチで即入室）

UI：1–2秒のローディング（障害時は「対話へ」ボタンで /chat 退避）。

4. テーマ選択ハブ /theme（認証必須）
4-1. 目的

用途（テーマ）を選んでもらい、以降の画面遷移を変える起点。

4-2. レイアウト（スワイプ対応・静的画像）

実装方式：スワイプ可能なカード形式

レイアウト：
- フルスクリーン表示
- 3つのテーマカードをスワイプで切り替え
- 各カード：背景グラデーション、タイトル、サブタイトル、コピー、説明文、CTAボタン

テーマ内容：
🌱 メンタル・自己理解
- コピー：「考えるより、感じるままで」
- 説明：「気づかないうちに、心が疲れていませんか。ここでは誰にも言えない想いや迷いを、静かに受け止めてくれる相手がいます。考えを整理したい時も、ただ話を聞いてほしい時も大丈夫です。」
- CTA：「整える」

💌 恋愛・人間関係
- コピー：「話すたびに、少しずつ近づいていく」
- 説明：「恋をしている時のドキドキも、誰かを想う切なさも。ここでは、あなたの気持ちをまっすぐ受け止めてくれる"誰か"がいます。恋愛の相談も、ちょっとした甘い会話も、すべて自由に。」
- CTA：「会いにいく」

💼 キャリア・目標達成
- コピー：「言葉にすれば、未来が動く」
- 説明：「このままでいいのかな」「もっと成長したい」どんな気持ちも、言葉にすることで自分の軸が見えてきます。ここでは、目標に向かうあなたの考えを整理し、次の一歩を後押しします。」
- CTA：「整理する」

遷移：
mental → /character-select?theme=mental
love → /character-select?theme=love
career → /character-select?theme=career
（設定から来た場合は &from=settings 付与）

5-3. 保存・遷移

保存：profiles.selected_character_id = <選択ID>（RLS）。

推奨：profiles.default_theme = <theme> も同時保存（後続最適化用）。

遷移：

初回：保存成功 → /onboarding

設定経由（?from=settings）：保存成功 → /chat（「コーチを切り替えました」トースト）。

5-4. エラー／空状態

取得失敗：スケルトン → トースト → 再読込。

0件：プレースホルダ3体＋「あとで選ぶ」で /chat（最低限担保）。

保存失敗：トースト＋直前選択IDで再送できる「もう一度保存」ボタン。

5-5. 画像要件 & パフォーマンス

フォーマット：webp/avif 併用、blurプレースホルダ。

サイズ：一覧 320–480px 辺、object-fit: cover、顔位置は事前クロップ統一。

Lazy Load＋IntersectionObserver、CDN最適化（Supabase Storage Transform 等）。

ALT：alt="<キャラ名>のコーチ画像"。

5-6. A11y

タップ領域 ≥ 44px、キーボード操作（Tab→Enter）可。

フォーカス可視化・ラベルのコントラスト 4.5:1 以上。

選択カードに aria-pressed。

6. 導入オンボーディング /onboarding（認証必須・初回のみ）

ステップ：

スタイル（励まし／論理／共感）

目標（短期／長期／期限）

通知（時間帯／頻度）

記憶方針（重要のみ／自動要約／保存しない）

初期値最適化：default_theme に応じて候補の順序や例文を出し分け。

完了：/chat へ（選んだコーチの初回挨拶を1回だけ表示）。

7. 対話（3D×コーチング） /chat（認証必須）

初期化：profiles.selected_character_id → characters を参照し、voice_model / personality / greeting_message を適用。

レイアウト：

メイン：3D（待機／表情／ジェスチャー／Cartesia TTS同期）

下部：入力・送信・音声開始/停止（将来 Whisper 切替可）

上部：セッション名・重要保存トグル

右下：音量／読み上げ／マイク

フォールバック：マイク拒否→テキスト案内、TTS失敗→テキストのみ、3D失敗→静的アバター。

記憶最適化：セッション終了時に要約プレビュー→保存方針選択（編集可）。

8. 設定 /settings（認証必須）

表示：キャラサイズ・透明度・位置

音声：Cartesia ボイスID・音量・読み上げON/OFF・話速

AI：応答速度・スタイル（丁寧／カジュアル）・メインLLM（Gemini／GPT）

記憶：保存方針・期間・対象（目標／行動／感情／提案履歴）・削除・エクスポート

アカウント：メール、連携プロバイダ、既定プロバイダ切替、解除、ログアウト、退会

コーチ：現在のコーチ（サムネ／名前）＋ 「コーチを変更」 → /coach?from=settings（→ テーマ → 画像選択 → 保存 → /chat）

9. 履歴 /history（認証必須）

機能：検索、期間、重要フラグフィルタ

カード：タイトル／日付／主要学び／次の一手

詳細：要約編集、重要切替、削除、エクスポート、**「この文脈で再開」**で /chat（コーチは維持）

10. プライバシー・データ管理 /privacy（認証必須）

現在の保存方針／期間の表示、データサイズ概算、JSON/CSV エクスポート、全削除（2段階確認）、匿名化。

11. エラーページ /404, /500

状況説明、トップへ、サポートへ。

12. ルーティング＆ガード（実装状況反映）
Path	未ログイン	ログイン済み	備考
/	LP（モーダル認証）	/chat	実装済み
/auth	廃止	廃止	モーダルベースに変更
/auth/callback	OAuth処理	OAuth処理	実装済み
/decision	/auth	分岐	実装済み（ローカルストレージベース）
/theme	/auth	表示	実装済み（スワイプ対応）
/character-select?theme=	/auth	表示	実装済み（ダミーデータ）
/chat	/auth	表示	実装済み
/help	表示	表示	実装済み
/privacy	表示	表示	実装済み
/terms	表示	表示	実装済み
/db-test	表示	表示	開発用ページ
/onboarding	/auth	表示	未実装
/settings	/auth	表示	未実装
/history	/auth	表示	未実装
/password-reset	廃止	廃止	

実装済み機能：
- ランディングページ（モーダル認証）
- テーマ選択（スワイプ対応）
- キャラクター選択（ダミーデータ）
- チャット（基本機能）
- 静的ページ（ヘルプ、プライバシー、利用規約）

未実装機能：
- オンボーディング
- 設定ページ
- 履歴ページ

13. 状態管理・永続化

クライアント：入力テキスト／録音／思考中／音声再生状態。

サーバ（Supabase）：

profiles (selected_character_id, default_theme)

characters (id, name, thumbnail_url, theme, popularity, …)

セッション要約＋重要フラグ（RLS）

設定（ユーザー単位）

14. 認証実装ノート

Supabase：Google／Microsoft 有効化、各環境のリダイレクトURI登録。

state／nonce／PKCE（SDK既定）を使用。

アカウントリンク：同一メールは同一アカウントにリンク。メール非公開の可能性がある場合は統合確認ダイアログ。

popup不可は自動でredirect。3rd-party Cookie 制限のヘルプ文言常備。

15. 非機能UI要件

初回起動→5秒以内に3D待機表示。

入力→3秒以内に先頭トークン表示（ストリーミング）。

回線不良時は簡易モードへフォールバック。

低速回線でも画像UIが破綻しない（blur→本画像・Lazy Load）。

16. 分析・ログ（PIIなし）

発火ポイント：OAuth成功／失敗、decision到達、theme_selected、character_selected、オンボ完了、対話開始、音声開始/停止、TTS再生、セッション保存、設定変更。

付帯情報：auth_ui_mode (signup|login), theme, character_id, 遷移結果（select/chat）。

匿名IDで送信（個人特定情報は送らない）。

17. 画面遷移フロー（実装状況反映）
LP (/) → モーダル認証 → OAuth成功 → /decision
  ├ 初回（selected_character_id null） → /theme
  │    ├ スワイプ：mental  → /character-select?theme=mental
  │    ├ スワイプ：love    → /character-select?theme=love
  │    └ スワイプ：career  → /character-select?theme=career
  │         └ 画像で選択→ローカルストレージ保存→ /chat
  └ 既存（selected_character_id あり） → /chat

実装済みフロー：
- LP → モーダル認証 → /decision → /theme → /character-select → /chat

未実装フロー：
- 設定経由：/settings → コーチを変更 → /theme?from=settings → … → /character-select?...&from=settings → 保存 → /chat
- オンボーディング：/character-select → /onboarding → /chat

18. 取得クエリ例（テーマ別・最小）
select id, name, thumbnail_url
from characters
where theme = 'mental'
order by popularity desc nulls last
limit 6;

19. QAチェック（抜粋）

 テーマ→キャラが1タップずつで明快／戻る導線は常時可視。

 画像だけで選べる（比率・背景・照明を統一）。

 取得ゼロ／保存失敗時の退避導線（/chat へ）あり。

 低速回線でも崩れない（blur→本画像、Lazy Load）。

 キーボード操作可能・A11y合格（コントラスト・フォーカスリング）。