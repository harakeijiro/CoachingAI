画面設計書（CoachingAI｜OAuth版・テーマ→画像キャラ選択・統合Auth）

本ドキュメントは要件定義に基づき、UIレイアウト／主要コンポーネント／状態遷移／ルーティング／エラーハンドリング／非機能UI要件を定義する。
認証は Supabase Auth（Google／Microsoft） の External OAuth のみを使用する。
初回導線：ログイン → テーマ選択 → テーマ別キャラを“静的画像のみ”で選択 → オンボーディング → 対話。

0. 前提・共通仕様

ヘッダー（共通）：左＝ロゴ（トップへ）／右＝未ログイン「新規登録」「ログイン」・ログイン後「設定」「ログアウト」「対話へ」。
背景は透明＋ブラー、スクロールで白背景に縮小固定。

フッター（共通）：規約／プライバシー／問い合わせ（ヘルプ）。

デザイン／演出：モード系（白＋黒＋インディゴ）。映像主役・最小コピー。
レスポンシブ、アクセシビリティ（A11y）、トースト／モーダル指針は従来踏襲。

3D＆音声：3D描画・Cartesia TTS 同期、記憶最適化UIは従来の要件通り。

データ前提：profiles.selected_character_id (uuid|null)・profiles.default_theme (text|null)、characters テーブル（id,name,thumbnail_url,theme …）。

1. ランディングページ /
1-1. トーン＆コンセプト

コンセプトコピー：「話すことで、心が動く。」

配色：白＋黒＋インディゴ。淡いグラデーションで上品に。

1-2. ヒーロー（動画＋テーマ同期）

レイアウト：左＝9秒ループ動画（🌱メンタル→💌恋愛→💼キャリア／各3秒）、右＝テーマ連動コピー＋CTA。

CTA：「AIと話してみる（無料）」→ /auth?mode=signup。

背景グラデと右上ドットインジケータでテーマ同期。

1-3. ミニ解説 & 最終CTA

見出し「AIと話す。それだけで、少し前に進める。」

3アイコン：🤖パーソナライズ／💬自然会話／📈継続サポート。

最終CTA：「話すことで、心が整う。」→ 「AIと話してみる（無料）」。

2. 認証（統合UI） /auth
2-1. 構成

見出し「はじめる」。

タブ（UI上の切替）：新規登録（既定）／ログイン。

新規コピー：「1分で始められます。メール入力は不要です。」

既存コピー：「以前のコーチとそのまま再開できます。」

プロバイダボタン（文言のみ切替）

新規：Googleで新規登録／Microsoftで新規登録

既存：Googleでログイン／Microsoftでログイン

規約／プライバシー／ヘルプリンク。

クエリ：?mode=signup|login で既定タブ切替（LPからは signup 推奨）。

2-2. 動作・エラー

ボタン押下→ Supabase OAuth（popup優先・不可ならredirect）。

成功→ /decision。

エラー（同意拒否／ポップアップブロック／リダイレクトURI不一致／3rd-party Cookie 制限）はトースト＋再試行・ヘルプ。

3. 分岐（初回／既存） /decision（認証必須・UI極小）

目的：ログイン直後に実データで初回/既存を仕分け。

ロジック：

profiles.selected_character_id === null → /theme（テーマ選択ハブ）

!== null → /chat（前回コーチで即入室）

UI：1–2秒のローディング（障害時は「対話へ」ボタンで /chat 退避）。

4. テーマ選択ハブ /theme（認証必須）
4-1. 目的

用途（テーマ）を選んでもらい、以降の画面遷移を変える起点。

4-2. レイアウト（静的画像のみ・直感選択）

見出し：「あなたのAIコーチを選びましょう」

サブ：「いま話したいテーマを選んでください」。

3カード（画像主役・1:1推奨）

🌱 メンタル・自己理解

💌 恋愛・人間関係

💼 キャリア・目標達成

画像クリック＝即遷移（ボタン無し）。

A11y：aria-label="メンタルを選ぶ" 等。

遷移：

mental → /character-select?theme=mental

love → /character-select?theme=love

career → /character-select?theme=career
（設定から来た場合は &from=settings 付与）

5. キャラクター選択（静的画像のみ） /character-select?theme=…（認証必須）
5-1. 目的

選ばれたテーマに最適な候補のみを提示し、画像だけで直感選択。

5-2. レイアウト

上部バー：左「あなたのAIコーチを選びましょう」／右 テーマバッジ＋「テーマを変更」（/coach へ）。

画像グリッド（3〜6枚・1:1推奨・文字は常時非表示）：

ホバー/フォーカス時のみ、下辺に半透明の小ラベル（名前）。

選択時：外枠ハイライト（2px）＋右上チェック。

固定フッター：

左：選択中のサムネ（小）＋名前（ここで初めて常時表示）

右：「このコーチにする」（未選択はdisabled）

5-3. 保存・遷移

保存：profiles.selected_character_id = <選択ID>（RLS）。

推奨：profiles.default_theme = <theme> も同時保存（後続最適化用）。

遷移：

初回：保存成功 → /onboarding

設定経由（?from=settings）：保存成功 → /chat（「コーチを切り替えました」トースト）。

5-4. エラー／空状態

取得失敗：スケルトン → トースト → 再読込。

0件：プレースホルダ3体＋「あとで選ぶ」で /chat（最低限担保）。

保存失敗：トースト＋直前選択IDで再送できる「もう一度保存」ボタン。

5-5. 画像要件 & パフォーマンス

フォーマット：webp/avif 併用、blurプレースホルダ。

サイズ：一覧 320–480px 辺、object-fit: cover、顔位置は事前クロップ統一。

Lazy Load＋IntersectionObserver、CDN最適化（Supabase Storage Transform 等）。

ALT：alt="<キャラ名>のコーチ画像"。

5-6. A11y

タップ領域 ≥ 44px、キーボード操作（Tab→Enter）可。

フォーカス可視化・ラベルのコントラスト 4.5:1 以上。

選択カードに aria-pressed。

6. 導入オンボーディング /onboarding（認証必須・初回のみ）

ステップ：

スタイル（励まし／論理／共感）

目標（短期／長期／期限）

通知（時間帯／頻度）

記憶方針（重要のみ／自動要約／保存しない）

初期値最適化：default_theme に応じて候補の順序や例文を出し分け。

完了：/chat へ（選んだコーチの初回挨拶を1回だけ表示）。

7. 対話（3D×コーチング） /chat（認証必須）

初期化：profiles.selected_character_id → characters を参照し、voice_model / personality / greeting_message を適用。

レイアウト：

メイン：3D（待機／表情／ジェスチャー／Cartesia TTS同期）

下部：入力・送信・音声開始/停止（将来 Whisper 切替可）

上部：セッション名・重要保存トグル

右下：音量／読み上げ／マイク

フォールバック：マイク拒否→テキスト案内、TTS失敗→テキストのみ、3D失敗→静的アバター。

記憶最適化：セッション終了時に要約プレビュー→保存方針選択（編集可）。

8. 設定 /settings（認証必須）

表示：キャラサイズ・透明度・位置

音声：Cartesia ボイスID・音量・読み上げON/OFF・話速

AI：応答速度・スタイル（丁寧／カジュアル）・メインLLM（Gemini／GPT）

記憶：保存方針・期間・対象（目標／行動／感情／提案履歴）・削除・エクスポート

アカウント：メール、連携プロバイダ、既定プロバイダ切替、解除、ログアウト、退会

コーチ：現在のコーチ（サムネ／名前）＋ 「コーチを変更」 → /coach?from=settings（→ テーマ → 画像選択 → 保存 → /chat）

9. 履歴 /history（認証必須）

機能：検索、期間、重要フラグフィルタ

カード：タイトル／日付／主要学び／次の一手

詳細：要約編集、重要切替、削除、エクスポート、**「この文脈で再開」**で /chat（コーチは維持）

10. プライバシー・データ管理 /privacy（認証必須）

現在の保存方針／期間の表示、データサイズ概算、JSON/CSV エクスポート、全削除（2段階確認）、匿名化。

11. エラーページ /404, /500

状況説明、トップへ、サポートへ。

12. ルーティング＆ガード（確定）
Path	未ログイン	ログイン済み	備考
/	LP	/chat	
/auth	表示（統合UI）	/chat	`?mode=signup
/decision	/auth	分岐	初回→/theme, 既存→/chat
/theme	/auth	表示	テーマ選択ハブ
/character-select?theme=	/auth	表示	画像でキャラ選択
/onboarding	/auth	表示	初回のみ
/chat	/auth	表示	対話
/settings /history /privacy	/auth	表示	
/password-reset	廃止	廃止	

Supabase セッションはリロードでも維持。

既存の /signup /signin は /auth へ 301 リダイレクト。

13. 状態管理・永続化

クライアント：入力テキスト／録音／思考中／音声再生状態。

サーバ（Supabase）：

profiles (selected_character_id, default_theme)

characters (id, name, thumbnail_url, theme, popularity, …)

セッション要約＋重要フラグ（RLS）

設定（ユーザー単位）

14. 認証実装ノート

Supabase：Google／Microsoft 有効化、各環境のリダイレクトURI登録。

state／nonce／PKCE（SDK既定）を使用。

アカウントリンク：同一メールは同一アカウントにリンク。メール非公開の可能性がある場合は統合確認ダイアログ。

popup不可は自動でredirect。3rd-party Cookie 制限のヘルプ文言常備。

15. 非機能UI要件

初回起動→5秒以内に3D待機表示。

入力→3秒以内に先頭トークン表示（ストリーミング）。

回線不良時は簡易モードへフォールバック。

低速回線でも画像UIが破綻しない（blur→本画像・Lazy Load）。

16. 分析・ログ（PIIなし）

発火ポイント：OAuth成功／失敗、decision到達、theme_selected、character_selected、オンボ完了、対話開始、音声開始/停止、TTS再生、セッション保存、設定変更。

付帯情報：auth_ui_mode (signup|login), theme, character_id, 遷移結果（select/chat）。

匿名IDで送信（個人特定情報は送らない）。

17. 画面遷移フロー（最終）
LP (/) → /auth → OAuth成功 → /decision
  ├ 初回（selected_character_id null） → /theme
  │    ├ クリック：mental  → /character-select?theme=mental
  │    ├ クリック：love    → /character-select?theme=love
  │    └ クリック：career  → /character-select?theme=career
  │         └ 画像で選択→保存→ /onboarding → /chat
  └ 既存（selected_character_id あり） → /chat
（設定から：/settings → コーチを変更 → /theme?from=settings → … → /character-select?...&from=settings → 保存 → /chat）

18. 取得クエリ例（テーマ別・最小）
select id, name, thumbnail_url
from characters
where theme = 'mental'
order by popularity desc nulls last
limit 6;

19. QAチェック（抜粋）

 テーマ→キャラが1タップずつで明快／戻る導線は常時可視。

 画像だけで選べる（比率・背景・照明を統一）。

 取得ゼロ／保存失敗時の退避導線（/chat へ）あり。

 低速回線でも崩れない（blur→本画像、Lazy Load）。

 キーボード操作可能・A11y合格（コントラスト・フォーカスリング）。