# メモリ機能セットアップチェックリスト

## 📋 実装完了内容の確認

以下の実装が完了していることを確認してください：

- [x] データベーススキーマの拡張
- [x] 型定義の作成（`front/lib/types/memory.ts`）
- [x] Server Actionsの作成（`front/lib/actions/memory.ts`）
- [x] メモリ抽出機能の実装（`front/lib/utils/memory-extraction.ts`）
- [x] ASR APIへの統合（`front/app/api/asr/route.ts`）
- [x] メモリ保存用APIエンドポイント（`front/app/api/memory/save/route.ts`）
- [x] マイグレーションファイル（`supabase/migrations/007_extend_memories_table.sql`）

---

## 🔧 セットアップ手順

### Step 1: マイグレーションの実行 ✅

**ファイル**: `supabase/MEMORY_MIGRATION_GUIDE.md` を参照

1. Supabaseダッシュボードを開く
2. SQL Editorで `007_extend_memories_table.sql` を実行
3. エラーなく実行完了することを確認

**確認コマンド（SQL Editor）**:
```sql
-- テーブル構造の確認
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_schema = 'public' AND table_name = 'memories'
ORDER BY ordinal_position;
```

期待されるカラム：
- `user_id` (uuid, nullable)
- `memory_type` (text, not null)
- `confidence` (numeric, nullable)
- `expires_at` (timestamptz, nullable)
- `deleted_at` (timestamptz, nullable)

---

### Step 2: 環境変数の確認 ✅

**必要な環境変数**:

```bash
# Supabase（必須）
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_URL=your_supabase_url  # サーバーサイド用
SUPABASE_ANON_KEY=your_anon_key  # サーバーサイド用

# Gemini API（必須）
GOOGLE_GENERATIVE_AI_API_KEY=your_gemini_api_key
GEMINI_MODEL=gemini-2.0-flash-exp  # または gemini-2.5-flash

# Cartesia TTS（必須）
CARTESIA_API_KEY=your_cartesia_api_key
CARTESIA_VERSION=2025-04-16

# OpenAI Whisper（必須）
OPENAI_API_KEY=your_openai_api_key

# アプリのベースURL（推奨、開発環境のみ）
NEXT_PUBLIC_APP_URL=http://localhost:3000
# 本番環境では自動検出（VERCEL_URL使用）
```

**確認方法**:
```bash
# .env.localファイルを確認
cat front/.env.local

# または、環境変数が設定されているか確認
# （Next.js開発サーバー起動時にログに表示される）
```

---

### Step 3: 開発サーバーの起動 ✅

```bash
cd front
npm run dev
```

**確認**:
- サーバーが正常に起動する
- エラーが表示されない
- `http://localhost:3000` にアクセスできる

---

### Step 4: 動作テスト ✅

詳細は `documents/メモリ機能テスト手順.md` を参照

**簡単なテスト手順**:

1. **チャットページを開く**
   - `http://localhost:3000/chat` にアクセス
   - ログインが必要な場合はログイン

2. **会話を開始（5メッセージ以上）**
   - 名前、年齢、家族構成など身の回りの情報を含む会話をする
   - 目標や行動パターンなども含める

3. **メモリ抽出の確認**
   - ブラウザの開発者ツール（F12）→ コンソールを開く
   - 5メッセージ目で以下のログが表示される：
     ```
     Step 4.5: Starting memory extraction...
     Step 4.5: Extracted X memories: [...]
     Step 4.5: Memories saved: {...}
     ```

4. **データベースの確認**
   - Supabaseダッシュボード → Table Editor → `memories`テーブル
   - 抽出されたメモリが保存されているか確認

---

## 🐛 トラブルシューティング

### 問題1: マイグレーションでエラーが発生する

**原因**:
- 既存のテーブル構造と競合
- 外部キー制約の問題
- RLSポリシーの競合

**対処法**:
1. エラーメッセージを確認
2. 既存のポリシーを削除してから再実行
3. テーブル構造を確認してから実行

### 問題2: メモリが抽出されない

**原因**:
- Gemini APIキーが設定されていない
- API呼び出しが失敗している
- 5メッセージに達していない

**対処法**:
1. コンソールのエラーログを確認
2. Gemini APIキーが正しく設定されているか確認
3. ユーザーの発話が5回以上あるか確認

### 問題3: メモリが保存されない

**原因**:
- Supabase認証が失敗している
- RLSポリシーでアクセスが拒否されている
- `user_id`が正しく設定されていない

**対処法**:
1. SupabaseダッシュボードでRLSポリシーを確認
2. 認証状態を確認
3. コンソールのエラーログを確認

### 問題4: Edge Runtimeでのエラー

**原因**:
- `NEXT_PUBLIC_APP_URL`が設定されていない
- 内部APIエンドポイントにアクセスできない

**対処法**:
1. 開発環境では`NEXT_PUBLIC_APP_URL=http://localhost:3000`を設定
2. 本番環境では`VERCEL_URL`が自動検出される
3. APIエンドポイントのルーティングを確認

---

## ✅ 完了チェックリスト

### セットアップ
- [ ] マイグレーションを実行
- [ ] 環境変数を設定
- [ ] 開発サーバーが起動

### 動作確認
- [ ] 会話を開始できる
- [ ] 5メッセージ目でメモリ抽出が実行される
- [ ] コンソールにログが表示される
- [ ] Supabaseにメモリが保存されている

### データ確認
- [ ] `memories`テーブルにレコードが作成されている
- [ ] `memory_type`が正しく設定されている
- [ ] `confidence`が0.7以上で設定されている
- [ ] `personal_info`タイプのメモリが保存されている

---

## 🎉 次のステップ

1. **メモリの利用**
   - 会話プロンプトにメモリを含める
   - 過去のメモリを参照して応答を生成

2. **メモリの管理UI**
   - 保存されたメモリを表示
   - メモリの編集・削除機能

3. **セッション要約機能**
   - セッション終了時に要約を作成
   - 要約からメモリを抽出

4. **メモリの有効期限管理**
   - `expires_at`に基づいて自動削除
   - ユーザー設定から保持期間を設定

---

## 📚 参考資料

- マイグレーションガイド: `supabase/MEMORY_MIGRATION_GUIDE.md`
- テスト手順: `documents/メモリ機能テスト手順.md`
- DB設計書: `documents/DB設計書.md`
- API設計書: `documents/API設計書.md`

