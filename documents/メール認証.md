Supabase × Next.js：メール認証＋1時間自動削除セットアップ手順（最新UI対応・PKCEエラー解消版）
🧭 全体のゴール

新規登録（メール＋パスワード入力）

Supabaseが「確認メール」を送信

リンクをクリック → 有効化・ログイン完了

1時間以内にクリックされなければ：
　- リンクが無効化（OTP期限3600秒）
　- 未確認ユーザー行が自動削除（Edge Function + Cron）

【STEP 1】Supabase ダッシュボード設定（UI）
✅ A. 認証（Auth）を有効化

Supabaseダッシュボード → Authentication → Configuration

タブ「Sign in / Providers」を開く

以下を設定する：

Enable Email Provider：ON  
Confirm Email：ON  
Email OTP Expiration：3600秒（1時間）  
Email OTP Length：6（デフォルトのままでOK）  


※「Sign in / Providers → Email」セクション内にあります。
※ メールリンクを踏むまで email_confirmed_at は null（未確認状態）
※ 3600秒でリンクは自動的に無効化されます。
※ PKCE（Proof Key for Code Exchange）は ON のままでOK。

✅ B. リダイレクトURL設定（新UI）

Authentication → Configuration → URL Configuration

Site URL：

以下のいずれかを使用：

開発環境（ローカル）：
http://localhost:3000

現在のSupabaseプロジェクトURLを利用する場合：
https://zvwvumtnwzzfiedfijjv.supabase.co

Allowed Redirect URLs：

複数登録する場合はカンマ区切りで1行にまとめて書く（ハイフン・改行はNG）

http://localhost:3000/auth/callback,https://zvwvumtnwzzfiedfijjv.supabase.co/auth/v1/callback


🔸意味

http://localhost:3000/auth/callback → 開発環境用

https://zvwvumtnwzzfiedfijjv.supabase.co/auth/v1/callback → Supabase認証サーバ用

⚠️ Allowed Redirectに登録されていないURLには遷移できません。

✅ C. メールテンプレート設定（HTML）

Authentication → Configuration → Emails → Templates → Confirm signup

以下のHTMLを貼り付けて保存（{{ .ConfirmationURL }} は自動で挿入されます）

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>サインアップ確認</title>
</head>
<body style="margin:0;padding:0;background:#fff;font-family:Arial, Helvetica, sans-serif;color:#111;">
  <div style="max-width:600px;margin:24px auto;padding:0 16px;">
    <h1 style="font-size:20px;line-height:1.4;margin:0 0 16px;">登録の確認をお願いします</h1>
    <p>以下のボタンをクリックして、PromptEC への登録を完了してください。</p>
    <table cellspacing="0" cellpadding="0" border="0" style="margin:20px 0;">
      <tr>
        <td style="border-radius:6px;background:#1a73e8;">
          <a href="{{ .ConfirmationURL }}" style="display:inline-block;padding:12px 20px;color:#fff;text-decoration:none;font-weight:bold;border-radius:6px;" target="_blank" rel="noopener">
            登録を完了する
          </a>
        </td>
      </tr>
    </table>
    <p>もしボタンが機能しない場合は、次のURLをブラウザに貼り付けてください：<br>
      <a href="{{ .ConfirmationURL }}" style="color:#1a73e8;word-break:break-all;">{{ .ConfirmationURL }}</a>
    </p>
    <hr style="border:none;border-top:1px solid #eee;margin:16px 0;" />
    <p>このリンクは1時間で無効になります。</p>
    <p>株式会社SEアシスト（〇〇@seassist.co.jp）</p>
  </div>
</body>
</html>

✅ D. メール送信方法（SMTP設定）

Authentication → Configuration → Emails → SMTP Settings

Enable Custom SMTP：OFF（内蔵メール機能でOK）


※ 本番移行時に Resend / SendGrid などへ切り替え推奨

【STEP 2】Next.js 側の設定
✅ A. 環境変数（.env.local）
NEXT_PUBLIC_SUPABASE_URL=https://zvwvumtnwzzfiedfijjv.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=あなたのAnonキー

✅ B. Supabaseクライアント（/lib/supabaseClient.ts）
import { createClient } from "@supabase/supabase-js";

export const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);

✅ C. サインアップ処理（/app/auth/register/page.tsx）
"use client";
import { useState } from "react";
import { supabase } from "@/lib/supabaseClient";

export default function RegisterPage() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [loading, setLoading] = useState(false);

  const handleRegister = async () => {
    setLoading(true);
    const { error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        emailRedirectTo: "https://zvwvumtnwzzfiedfijjv.supabase.co/auth/v1/callback",
      },
    });

    setLoading(false);
    if (error) alert("登録エラー: " + error.message);
    else alert("確認メールを送信しました。リンクをクリックしてください。");
  };

  return (
    <div style={{ padding: 24 }}>
      <h1>新規登録</h1>
      <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="メール" />
      <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="パスワード" />
      <button onClick={handleRegister} disabled={loading}>
        {loading ? "送信中..." : "登録する"}
      </button>
    </div>
  );
}

✅ D. コールバック処理（/app/auth/callback/page.tsx）
"use client";
import { useEffect, useState } from "react";
import { supabase } from "@/lib/supabaseClient";

export default function AuthCallback() {
  const [status, setStatus] = useState("認証処理中です...");

  useEffect(() => {
    (async () => {
      const code = new URLSearchParams(window.location.search).get("code");
      if (!code) return setStatus("認証コードが見つかりません。");
      const { error } = await supabase.auth.exchangeCodeForSession(code);
      if (error) setStatus("認証に失敗しました：" + error.message);
      else {
        setStatus("認証成功！ダッシュボードに移動します...");
        window.location.href = "/dashboard";
      }
    })();
  }, []);

  return <p>{status}</p>;
}

【STEP 3】未確認ユーザーを自動削除（Edge Function）
✅ A. 関数を作成
supabase functions new cleanup-unconfirmed-users

✅ B. 関数コード（/supabase/functions/cleanup-unconfirmed-users/index.ts）
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const MINUTES = Number(Deno.env.get("CLEANUP_MINUTES") ?? "60");

Deno.serve(async () => {
  const supabase = createClient(
    Deno.env.get("SUPABASE_URL")!,
    Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!
  );

  const cutoff = new Date(Date.now() - MINUTES * 60 * 1000);
  let deleted = 0, page = 1;

  while (true) {
    const { data, error } = await supabase.auth.admin.listUsers({ page, perPage: 1000 });
    if (error) return new Response(error.message, { status: 500 });
    if (!data?.users.length) break;

    for (const u of data.users) {
      const isUnconfirmed = !u.email_confirmed_at;
      const createdAt = new Date(u.created_at);
      if (isUnconfirmed && createdAt < cutoff) {
        await supabase.auth.admin.deleteUser(u.id, { shouldSoftDelete: true });
        deleted++;
      }
    }
    page++;
  }

  return new Response(JSON.stringify({ deleted, cutoff: cutoff.toISOString() }), {
    headers: { "Content-Type": "application/json" },
  });
});

✅ C. 環境変数設定
supabase secrets set SUPABASE_URL="https://zvwvumtnwzzfiedfijjv.supabase.co"
supabase secrets set SUPABASE_SERVICE_ROLE_KEY="service_role_key"
supabase secrets set CLEANUP_MINUTES="60"

✅ D. デプロイ
supabase functions deploy cleanup-unconfirmed-users

✅ E. Cron拡張を有効化

Supabase → Integrations → Cron → 「Enable pg_cron」

Select a schema：extensions を選択（推奨）

確認SQL（任意）：

SELECT * FROM pg_extension WHERE extname = 'pg_cron';

✅ F. Cronジョブ登録（10分ごと）

Supabase → Integrations → Cron → Create Job

Name：cleanup-unconfirmed-users-job
Schedule：*/10 * * * *
Type：Supabase Edge Function
Method：POST
Timeout：5000 ms
HTTP Headers：空欄
HTTP Request Body：空欄
Edge Function：cleanup-unconfirmed-users


※ Edge Function が表示されない場合は先に deploy を実行。
※ 「Install pg_net extension」が出た場合は初回だけ有効化。

【STEP 4】テスト方法

signUp() を実行（新規登録）

Supabase → Authentication → Users に email_confirmed_at = null の未確認ユーザーが作成される

メールをクリックせず放置

1時間後、Cronが実行され自動削除されることを確認