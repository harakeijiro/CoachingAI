Supabase Ã— Next.jsï¼šãƒ¡ãƒ¼ãƒ«èªè¨¼ï¼‹1æ™‚é–“è‡ªå‹•å‰Šé™¤ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ï¼ˆæœ€æ–°UIå¯¾å¿œãƒ»PKCEã‚¨ãƒ©ãƒ¼è§£æ¶ˆç‰ˆï¼‰
ğŸ§­ å…¨ä½“ã®ã‚´ãƒ¼ãƒ«

æ–°è¦ç™»éŒ²ï¼ˆãƒ¡ãƒ¼ãƒ«ï¼‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ï¼‰

SupabaseãŒã€Œç¢ºèªãƒ¡ãƒ¼ãƒ«ã€ã‚’é€ä¿¡

ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ æœ‰åŠ¹åŒ–ãƒ»ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†

1æ™‚é–“ä»¥å†…ã«ã‚¯ãƒªãƒƒã‚¯ã•ã‚Œãªã‘ã‚Œã°ï¼š
ã€€- ãƒªãƒ³ã‚¯ãŒç„¡åŠ¹åŒ–ï¼ˆOTPæœŸé™3600ç§’ï¼‰
ã€€- æœªç¢ºèªãƒ¦ãƒ¼ã‚¶ãƒ¼è¡ŒãŒè‡ªå‹•å‰Šé™¤ï¼ˆEdge Function + Cronï¼‰

ã€STEP 1ã€‘Supabase ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¨­å®šï¼ˆUIï¼‰
âœ… A. èªè¨¼ï¼ˆAuthï¼‰ã‚’æœ‰åŠ¹åŒ–

Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ Authentication â†’ Configuration

ã‚¿ãƒ–ã€ŒSign in / Providersã€ã‚’é–‹ã

ä»¥ä¸‹ã‚’è¨­å®šã™ã‚‹ï¼š

Enable Email Providerï¼šON  
Confirm Emailï¼šON  
Email OTP Expirationï¼š3600ç§’ï¼ˆ1æ™‚é–“ï¼‰  
Email OTP Lengthï¼š6ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã§OKï¼‰  


â€»ã€ŒSign in / Providers â†’ Emailã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã«ã‚ã‚Šã¾ã™ã€‚
â€» ãƒ¡ãƒ¼ãƒ«ãƒªãƒ³ã‚¯ã‚’è¸ã‚€ã¾ã§ email_confirmed_at ã¯ nullï¼ˆæœªç¢ºèªçŠ¶æ…‹ï¼‰
â€» 3600ç§’ã§ãƒªãƒ³ã‚¯ã¯è‡ªå‹•çš„ã«ç„¡åŠ¹åŒ–ã•ã‚Œã¾ã™ã€‚
â€» PKCEï¼ˆProof Key for Code Exchangeï¼‰ã¯ ON ã®ã¾ã¾ã§OKã€‚

âœ… B. ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURLè¨­å®šï¼ˆæ–°UIï¼‰

Authentication â†’ Configuration â†’ URL Configuration

Site URLï¼š

ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã‚’ä½¿ç”¨ï¼š

é–‹ç™ºç’°å¢ƒï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰ï¼š
http://localhost:3000

ç¾åœ¨ã®Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆURLã‚’åˆ©ç”¨ã™ã‚‹å ´åˆï¼š
https://zvwvumtnwzzfiedfijjv.supabase.co

Allowed Redirect URLsï¼š

è¤‡æ•°ç™»éŒ²ã™ã‚‹å ´åˆã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§1è¡Œã«ã¾ã¨ã‚ã¦æ›¸ãï¼ˆãƒã‚¤ãƒ•ãƒ³ãƒ»æ”¹è¡Œã¯NGï¼‰

http://localhost:3000/auth/callback,https://zvwvumtnwzzfiedfijjv.supabase.co/auth/v1/callback


ğŸ”¸æ„å‘³

http://localhost:3000/auth/callback â†’ é–‹ç™ºç’°å¢ƒç”¨

https://zvwvumtnwzzfiedfijjv.supabase.co/auth/v1/callback â†’ Supabaseèªè¨¼ã‚µãƒ¼ãƒç”¨

âš ï¸ Allowed Redirectã«ç™»éŒ²ã•ã‚Œã¦ã„ãªã„URLã«ã¯é·ç§»ã§ãã¾ã›ã‚“ã€‚

âœ… C. ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨­å®šï¼ˆHTMLï¼‰

Authentication â†’ Configuration â†’ Emails â†’ Templates â†’ Confirm signup

ä»¥ä¸‹ã®HTMLã‚’è²¼ã‚Šä»˜ã‘ã¦ä¿å­˜ï¼ˆ{{ .ConfirmationURL }} ã¯è‡ªå‹•ã§æŒ¿å…¥ã•ã‚Œã¾ã™ï¼‰

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ç¢ºèª</title>
</head>
<body style="margin:0;padding:0;background:#fff;font-family:Arial, Helvetica, sans-serif;color:#111;">
  <div style="max-width:600px;margin:24px auto;padding:0 16px;">
    <h1 style="font-size:20px;line-height:1.4;margin:0 0 16px;">ç™»éŒ²ã®ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™</h1>
    <p>ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€PromptEC ã¸ã®ç™»éŒ²ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚</p>
    <table cellspacing="0" cellpadding="0" border="0" style="margin:20px 0;">
      <tr>
        <td style="border-radius:6px;background:#1a73e8;">
          <a href="{{ .ConfirmationURL }}" style="display:inline-block;padding:12px 20px;color:#fff;text-decoration:none;font-weight:bold;border-radius:6px;" target="_blank" rel="noopener">
            ç™»éŒ²ã‚’å®Œäº†ã™ã‚‹
          </a>
        </td>
      </tr>
    </table>
    <p>ã‚‚ã—ãƒœã‚¿ãƒ³ãŒæ©Ÿèƒ½ã—ãªã„å ´åˆã¯ã€æ¬¡ã®URLã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼š<br>
      <a href="{{ .ConfirmationURL }}" style="color:#1a73e8;word-break:break-all;">{{ .ConfirmationURL }}</a>
    </p>
    <hr style="border:none;border-top:1px solid #eee;margin:16px 0;" />
    <p>ã“ã®ãƒªãƒ³ã‚¯ã¯1æ™‚é–“ã§ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚</p>
    <p>æ ªå¼ä¼šç¤¾SEã‚¢ã‚·ã‚¹ãƒˆï¼ˆã€‡ã€‡@seassist.co.jpï¼‰</p>
  </div>
</body>
</html>

âœ… D. ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ–¹æ³•ï¼ˆSMTPè¨­å®šï¼‰

Authentication â†’ Configuration â†’ Emails â†’ SMTP Settings

Enable Custom SMTPï¼šOFFï¼ˆå†…è”µãƒ¡ãƒ¼ãƒ«æ©Ÿèƒ½ã§OKï¼‰


â€» æœ¬ç•ªç§»è¡Œæ™‚ã« Resend / SendGrid ãªã©ã¸åˆ‡ã‚Šæ›¿ãˆæ¨å¥¨

ã€STEP 2ã€‘Next.js å´ã®è¨­å®š
âœ… A. ç’°å¢ƒå¤‰æ•°ï¼ˆ.env.localï¼‰
NEXT_PUBLIC_SUPABASE_URL=https://zvwvumtnwzzfiedfijjv.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=ã‚ãªãŸã®Anonã‚­ãƒ¼

âœ… B. Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆ/lib/supabaseClient.tsï¼‰
import { createClient } from "@supabase/supabase-js";

export const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);

âœ… C. ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†ï¼ˆ/app/auth/register/page.tsxï¼‰
"use client";
import { useState } from "react";
import { supabase } from "@/lib/supabaseClient";

export default function RegisterPage() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [loading, setLoading] = useState(false);

  const handleRegister = async () => {
    setLoading(true);
    const { error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        emailRedirectTo: "https://zvwvumtnwzzfiedfijjv.supabase.co/auth/v1/callback",
      },
    });

    setLoading(false);
    if (error) alert("ç™»éŒ²ã‚¨ãƒ©ãƒ¼: " + error.message);
    else alert("ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚");
  };

  return (
    <div style={{ padding: 24 }}>
      <h1>æ–°è¦ç™»éŒ²</h1>
      <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="ãƒ¡ãƒ¼ãƒ«" />
      <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
      <button onClick={handleRegister} disabled={loading}>
        {loading ? "é€ä¿¡ä¸­..." : "ç™»éŒ²ã™ã‚‹"}
      </button>
    </div>
  );
}

âœ… D. ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ï¼ˆ/app/auth/callback/page.tsxï¼‰
"use client";
import { useEffect, useState } from "react";
import { supabase } from "@/lib/supabaseClient";

export default function AuthCallback() {
  const [status, setStatus] = useState("èªè¨¼å‡¦ç†ä¸­ã§ã™...");

  useEffect(() => {
    (async () => {
      const code = new URLSearchParams(window.location.search).get("code");
      if (!code) return setStatus("èªè¨¼ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
      const { error } = await supabase.auth.exchangeCodeForSession(code);
      if (error) setStatus("èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + error.message);
      else {
        setStatus("èªè¨¼æˆåŠŸï¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ç§»å‹•ã—ã¾ã™...");
        window.location.href = "/dashboard";
      }
    })();
  }, []);

  return <p>{status}</p>;
}

ã€STEP 3ã€‘æœªç¢ºèªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è‡ªå‹•å‰Šé™¤ï¼ˆEdge Functionï¼‰
âœ… A. é–¢æ•°ã‚’ä½œæˆ
supabase functions new cleanup-unconfirmed-users

âœ… B. é–¢æ•°ã‚³ãƒ¼ãƒ‰ï¼ˆ/supabase/functions/cleanup-unconfirmed-users/index.tsï¼‰
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const MINUTES = Number(Deno.env.get("CLEANUP_MINUTES") ?? "60");

Deno.serve(async () => {
  const supabase = createClient(
    Deno.env.get("SUPABASE_URL")!,
    Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!
  );

  const cutoff = new Date(Date.now() - MINUTES * 60 * 1000);
  let deleted = 0, page = 1;

  while (true) {
    const { data, error } = await supabase.auth.admin.listUsers({ page, perPage: 1000 });
    if (error) return new Response(error.message, { status: 500 });
    if (!data?.users.length) break;

    for (const u of data.users) {
      const isUnconfirmed = !u.email_confirmed_at;
      const createdAt = new Date(u.created_at);
      if (isUnconfirmed && createdAt < cutoff) {
        await supabase.auth.admin.deleteUser(u.id, { shouldSoftDelete: true });
        deleted++;
      }
    }
    page++;
  }

  return new Response(JSON.stringify({ deleted, cutoff: cutoff.toISOString() }), {
    headers: { "Content-Type": "application/json" },
  });
});

âœ… C. ç’°å¢ƒå¤‰æ•°è¨­å®š
supabase secrets set SUPABASE_URL="https://zvwvumtnwzzfiedfijjv.supabase.co"
supabase secrets set SUPABASE_SERVICE_ROLE_KEY="service_role_key"
supabase secrets set CLEANUP_MINUTES="60"

âœ… D. ãƒ‡ãƒ—ãƒ­ã‚¤
supabase functions deploy cleanup-unconfirmed-users

âœ… E. Cronæ‹¡å¼µã‚’æœ‰åŠ¹åŒ–

Supabase â†’ Integrations â†’ Cron â†’ ã€ŒEnable pg_cronã€

Select a schemaï¼šextensions ã‚’é¸æŠï¼ˆæ¨å¥¨ï¼‰

ç¢ºèªSQLï¼ˆä»»æ„ï¼‰ï¼š

SELECT * FROM pg_extension WHERE extname = 'pg_cron';

âœ… F. Cronã‚¸ãƒ§ãƒ–ç™»éŒ²ï¼ˆ10åˆ†ã”ã¨ï¼‰

Supabase â†’ Integrations â†’ Cron â†’ Create Job

Nameï¼šcleanup-unconfirmed-users-job
Scheduleï¼š*/10 * * * *
Typeï¼šSupabase Edge Function
Methodï¼šPOST
Timeoutï¼š5000 ms
HTTP Headersï¼šç©ºæ¬„
HTTP Request Bodyï¼šç©ºæ¬„
Edge Functionï¼šcleanup-unconfirmed-users


â€» Edge Function ãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯å…ˆã« deploy ã‚’å®Ÿè¡Œã€‚
â€» ã€ŒInstall pg_net extensionã€ãŒå‡ºãŸå ´åˆã¯åˆå›ã ã‘æœ‰åŠ¹åŒ–ã€‚

ã€STEP 4ã€‘ãƒ†ã‚¹ãƒˆæ–¹æ³•

signUp() ã‚’å®Ÿè¡Œï¼ˆæ–°è¦ç™»éŒ²ï¼‰

Supabase â†’ Authentication â†’ Users ã« email_confirmed_at = null ã®æœªç¢ºèªãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã•ã‚Œã‚‹

ãƒ¡ãƒ¼ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã›ãšæ”¾ç½®

1æ™‚é–“å¾Œã€CronãŒå®Ÿè¡Œã•ã‚Œè‡ªå‹•å‰Šé™¤ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª